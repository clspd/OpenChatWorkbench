# 实现对话创建和消息发送功能

## 1. 完善类型定义

* 更新 `src/types/index.ts`，定义对话和消息的数据结构

## 2. 实现对话管理功能

* 在 `src/modules/chat/conversation.ts` 中实现对话的创建、保存和加载功能

* 使用 @/userdata.ts 的 fs 模块管理文件

* 对话文件将存储在 `/data/conversations/{UUID}.json`

## 3. 实现消息管理功能

* 在 `src/modules/chat/message.ts` 中实现消息的发送和管理功能

## 4. 更新组件

* 修改 `src/views/NewChat.vue`，实现对话创建和消息发送

* 更新 `src/views/ChatView.vue`，实现对话显示和继续发送消息

## 5. 实现文件目录管理

* 确保 `/data/conversations/` 目录存在，不存在则创建

## 6. 实现路由跳转

* 当创建新对话并发送消息后，跳转到对应的聊天视图

## 7. 测试功能

* 测试对话创建功能

* 测试消息发送功能

* 测试对话文件的保存和加载

## 数据结构设计

### 对话数据结构

```typescript
enum SchemaVersion {
  V1 = 1
}

interface Conversation {
  schemaVersion: number; // 1
  id: string; // UUID
  session: {
    created_at: number; // Timestamp
    updated_at: number;
    title: string;
    title_type: "USER" | "SYSTEM";

  }
  messages: Message[]
}

interface ConversationUserPref {
    schemaVersion: number; // 1
    id: string; // 和Conversation的id相同
    current_message_id: number;
    pinned: boolean;
    last_access_at: number;
}
```

### 消息数据结构

```typescript
enum MessageRole {
  USER = 'USER',
  ASSISTANT = 'ASSISTANT',
  SYSTEM = 'SYSTEM'
}

enum MessageStatus {
  FINISHED = 'FINISHED',
  WIP = 'WIP'
}

enum MessageFeedback {
    NOT_PROVIDED = null,
    POSITIVE = 'POSITIVE',
    NEGATIVE = 'NEGATIVE',
}

interface Message {
  id: number; // 从 1 开始
  parent_id: number | null; // null表示根消息
  accumulated_token_usage: number;
  model: string; // modelId
  provider: string; // providerId
  providerName: string;
  thinking_enabled: boolean; 
  role: MessageRole;
  feedback: MessageFeedback;
  status: MessageStatus; // finished or work in progress
  files: FileAttachmentInfo[];
  fragments: MessageFragment[];
  has_pending_fragment: boolean;
}

interface FileAttachmentInfo {
    id: string; // file UUID
    name: string;
}

interface MessageFragment {
    id: number;
    type: "REQUEST" | "THINK" | "RESPONSE";
    elapsed: number; // 消耗的秒数
    content: MessageContent;
}

type MessageContent = string;
```

